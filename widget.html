<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ITC Presale Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: none;
      font-family: 'Inter', 'Montserrat', Arial, sans-serif;
      color: #eaf6fd;
      box-sizing: border-box;
    }
    #presale-widget {
      width: 100%;
      max-width: 370px;
      margin: 0 auto;
      border-radius: 18px;
      background: linear-gradient(135deg, #0a1a35 0%, #1e2d3d 35%, #2d6cf6 100%);
      box-shadow: 0 4px 16px #162a4a1a, 0 1px 3px #00ffe72c;
      padding: 35px 20px 32px 20px;
      color: #fff;
      text-align: center;
      position: relative;
      border: 1px solid rgba(90,180,255,0.07);
      backdrop-filter: blur(10px);
    }
    #tab-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 19px;
      gap: 12px;
      width: 100%;
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 12px 0;
      font-size: 1.08rem;
      font-weight: 600;
      color: #a4cfff;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.17s, color 0.17s;
    }
    .tab-btn.active {
      background: linear-gradient(93deg, #31afe6 50%, #2d6cf6 98%);
      color: #fff;
      box-shadow: 0 1px 12px #2fc5ff19;
    }
    .wallet-choice-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 14px; margin: 12px 0 17px 0;
    }
    .wallet-pill {
      display: flex;
      align-items: center;
      gap: 7px;
      border-radius: 8px;
      padding: 7px 15px;
      font-size: 1rem;
      cursor: pointer;
      background: #17365c55;
      border: 1.5px solid transparent;
      transition: border 0.17s, background 0.18s;
      font-weight: 600;
      color: #fff;
    }
    .wallet-pill.selected {
      border: 2px solid #2dcff7;
      background: #1e376255;
    }
    .wallet-pill img {
      height: 22px;
      width: 22px;
      border-radius: 3px;
      object-fit: contain;
      background: #222d;
    }
    .input-label {
      font-size: 16px;
      color: #a4cfff;
      text-align:left;
      margin: 7px 0 4px 0;
    }
    .buy-input-row {
      display: flex;
      align-items: center;
      gap: 9px;
      margin-bottom: 6px;
      width: 100%;
    }
    .buy-input-row input[type="number"] {
      width: 45%;
      padding: 10px;
      font-size: 1.05rem;
      border-radius: 10px;
      border: none;
      background: #182a47;
      color: #fafcff;
      transition: border 0.14s;
      outline: none;
    }
    .buy-input-row input[type="number"]:focus {
      border: 1.3px solid #22c1ff;
      background: #193869;
    }
    .input-eq-label { font-size: 1rem; color: #44ffd1; margin-bottom: 7px; }
    .payment-list { color: #7cd4ff; font-size: 1.06rem; font-weight: 500; margin-bottom: 7px;}
    button {
      width: 100%;
      border-radius: 14px;
      background: linear-gradient(90deg, #2038a8, #2d6cf6 70%);
      color: #fff;
      border: none;
      font-size: 1.09rem;
      padding: 13px 0;
      cursor:pointer;
      font-weight: 700;
      box-shadow: 0 1px 14px 0 #2fc5ff19;
      transition: background 0.23s;
      margin-top: 10px;
    }
    button:disabled { background: #25344f; color: #b3c0df;}
    #walletStatus, #buyResult { min-height: 20px; font-size: 1rem;}
    @media (max-width:500px) {
      #presale-widget { max-width:98vw; padding:11px;}
    }
  </style>
</head>
<body>
  <div id="presale-widget">
    <div id="tab-row">
      <button class="tab-btn active" id="tab-wallet">Pay with Wallet</button>
      <button class="tab-btn" id="tab-card">Pay with Card</button>
    </div>
    <div id="widget-main-area"></div>
  </div>
<script>
const PHASE1_PRICE_USDC = 0.50;
let currentEthPrice = 4302.55;
let provider, signer, connectedAddress, selectedCurrency = "ETH", tokenApproved = false;
const PRESALE_CONTRACT = "0xd1887abfadc7b5de18c54a547490c8dea792686b";
const T2TO_ADDRESS = "0xDd0C8f1AA8abDb162632F61EdE9b07ffED1eB333";
const PYUSD_ADDRESS = "0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9";
const presaleAbi = [
  "function buyWithETH(uint256 tokenAmount) external payable",
  "function buyWithToken(uint256 tokenAmount, address erc20Token) external"
];
const erc20Abi = [
  "function approve(address spender, uint256 value) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
const CURRENCIES = [
  {symbol: "ETH", name: "Ethereum (Sepolia)", icon: "Ethereum-logo.png", addr: null, abi: null, decimals: 18},
  {symbol: "PYUSD", name: "PYUSD", icon: "PYUSD-Logo.png", addr: PYUSD_ADDRESS, abi: erc20Abi, decimals: 18},
  {symbol: "T2TO", name: "T2TO", icon: "T2-Logo.png", addr: T2TO_ADDRESS, abi: erc20Abi, decimals: 18},
];
function fetchEthUsd() {
  fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd")
    .then(res => res.json())
    .then(data => { if (data.ethereum && data.ethereum.usd) currentEthPrice = data.ethereum.usd; updatePriceHelpers(); })
    .catch(()=>{});
}
fetchEthUsd();
setInterval(fetchEthUsd, 15000);
function updatePriceHelpers() {
  const eqSummary = document.getElementById('wallet-eq-summary');
  if (eqSummary) {
    if (selectedCurrency === "ETH") {
      eqSummary.innerHTML = `1 ITC = ${(PHASE1_PRICE_USDC/currentEthPrice).toFixed(6)} ETH <br>1 ITC = $0.50 USDC`;
    } else {
      eqSummary.innerHTML = `1 ITC = $0.50 USDC`;
    }
  }
}
function sanitizeAmount(val) {
  val = String(val || '').trim();
  if (val.includes('.')) {
    let [whole, fraction] = val.split('.');
    fraction = (fraction || '').slice(0, 18).replace(/0+$/, "");
    return whole + (fraction ? '.' + fraction : '');
  }
  return val;
}
function showWalletUI() {
  document.getElementById('widget-main-area').innerHTML = `
    <h2 style="margin-bottom:13px;">ITC Presale Purchase</h2>
    <div id="countdown-timer" style="font-size:1.15em; color:#43e6ff; font-weight:600;margin-bottom:8px"></div>
    <div class="msg-main"><strong>Phase 1:</strong> <span style="color:#affcff;">$0.50 USDC / ITC</span></div>
    <div class="msg-urgency" style="font-size:1em;">🚀🚀🚀 Price goes up to $0.75 USDC next phase!</div>
    <div class="wallet-choice-row" id="walletChoiceRow">
      ${CURRENCIES.map((cur, i) => `
        <div class="wallet-pill${i===0?' selected':''}" data-idx="${i}" id="pill-${cur.symbol}">
          <img src="${cur.icon}" alt="${cur.symbol} logo"/> ${cur.symbol}
        </div>`).join('')}
    </div>
    <div class="input-label">Select amount to purchase:</div>
    <div class="buy-input-row">
      <input type="number" id="itcInput" min="0" step="any" placeholder="ITC Amount" style="margin-right:7px;">
      <span style="font-size:1.18em; color:#bbb; font-weight:bold;">or</span>
      <input type="number" id="usdInput" min="0" step="any" placeholder="USD Amount">
    </div>
    <div class="input-eq-label" id="wallet-eq-summary">1 ITC = $0.50 USDC</div>
    <div class="payment-list" id="wallet-payment-desc">Pay with <span style="font-weight:700;color:#8ce0fc;">Ethereum (Sepolia)</span>, <span style="color:#8ce0fc;">PYUSD</span>, or <span style="color:#8ce0fc;">T2TO</span> wallet</div>
    <button id="connectWalletBtn">Connect Wallet</button>
    <div id="walletStatus"></div>
    <button id="approveBtn" style="display:none;">Approve</button>
    <button id="buyWithBtn" disabled>Buy ITC With Wallet</button>
    <div id="buyResult"></div>
  `;
  updateWalletPillListeners();
  updatePriceHelpers();
  bindDualInputs();
  setCountdownTimer();
}
function setCountdownTimer() {
  const END = new Date("2026-03-09T00:00:00Z").getTime();
  function tick() {
    let now = Date.now();
    let ms = END-now;
    if (ms<0) ms=0;
    let d = Math.floor(ms/86400000), h = Math.floor((ms%86400000)/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
    document.getElementById("countdown-timer").textContent = `Presale countdown (UTC): ${d}d ${h}h ${m}m ${s}s left`;
  }
  tick(); setInterval(tick, 1000);
}
function updateWalletPillListeners() {
  document.querySelectorAll('.wallet-pill').forEach((pill, i) => {
    pill.onclick = function() {
      document.querySelectorAll('.wallet-pill').forEach(p=>p.classList.remove('selected'));
      pill.classList.add('selected');
      selectedCurrency = CURRENCIES[i].symbol;
      document.getElementById('wallet-payment-desc').innerHTML = `Pay with <span style="font-weight:700;color:#8ce0fc;">${CURRENCIES[i].name}</span> wallet`;
      updatePriceHelpers();
      updateApproveUI();
    }
  });
}
function bindDualInputs() {
  let lock=false;
  const itcInput = document.getElementById('itcInput');
  const usdInput = document.getElementById('usdInput');
  itcInput.oninput = function() {
    if(lock)return; lock=1;
    usdInput.value = (+itcInput.value * PHASE1_PRICE_USDC).toFixed(2) || "";
    lock=0;
    updateApproveUI();
  }
  usdInput.oninput = function() {
    if(lock)return; lock=1;
    itcInput.value = (+usdInput.value / PHASE1_PRICE_USDC).toFixed(2) || "";
    lock=0;
    updateApproveUI();
  }
}
document.addEventListener('click', async function(e) {
  if (e.target && e.target.id === 'connectWalletBtn') {
    const walletStatus = document.getElementById("walletStatus");
    walletStatus.textContent = "";
    try {
      if (!window.ethereum) throw new Error("MetaMask not detected.");
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      connectedAddress = await signer.getAddress();
      document.getElementById("buyWithBtn").disabled = false;
      walletStatus.textContent = `Connected: ${connectedAddress}`;
      updateApproveUI();
    } catch (err) {
      walletStatus.textContent = "Wallet connection failed: " + (err.message || err);
    }
  }
});
async function updateApproveUI() {
  const approveBtn = document.getElementById("approveBtn");
  const buyBtn = document.getElementById("buyWithBtn");
  if(selectedCurrency==="ETH"){
    approveBtn.style.display="none"; buyBtn.disabled=false;
    return;
  }
  if(!provider || !signer) { approveBtn.style.display="none"; buyBtn.disabled=true; return; }
  const token = CURRENCIES.find(x=>x.symbol===selectedCurrency);
  if(!token.addr) {approveBtn.style.display="none"; buyBtn.disabled=true; return; }
  const tokenContract = new ethers.Contract(token.addr, erc20Abi, signer);
  const itcInput = document.getElementById('itcInput');
  let amt = sanitizeAmount(itcInput.value);
  let required;
  try { required = ethers.utils.parseUnits(amt || "0", 18); } catch { required = ethers.BigNumber.from("0"); }
  try {
    let allowance = await tokenContract.allowance(connectedAddress, PRESALE_CONTRACT);
    if(allowance.gte(required) && +amt>0){
      approveBtn.style.display = "none";
      buyBtn.disabled = false;
      tokenApproved = true;
    }else{
      approveBtn.style.display = "block";
      buyBtn.disabled = true;
      tokenApproved = false;
    }
  } catch { approveBtn.style.display="block"; buyBtn.disabled=true;tokenApproved=false;}
}
document.addEventListener('click', async function(e){
  if(e.target && e.target.id==="approveBtn") {
    const approveBtn = document.getElementById("approveBtn");
    const buyBtn = document.getElementById("buyWithBtn");
    const itcInput = document.getElementById('itcInput');
    if(!provider||!signer||!connectedAddress)return;
    const token = CURRENCIES.find(x=>x.symbol===selectedCurrency);
    if(!token.addr) return;
    approveBtn.disabled=true;
    try{
      const tokenContract = new ethers.Contract(token.addr, erc20Abi, signer);
      const amt = sanitizeAmount(itcInput.value);
      const value = ethers.utils.parseUnits(amt, 18);
      const tx = await tokenContract.approve(PRESALE_CONTRACT, value);
      approveBtn.textContent = "Approving...";
      await tx.wait();
      approveBtn.textContent = "Approve";
      buyBtn.disabled = false;
      tokenApproved = true;
    }catch(err){approveBtn.textContent="Approve";alert("Approval failed: "+(err.message||err));buyBtn.disabled=true;}
    approveBtn.disabled=false;
  }
});
document.addEventListener('click', async function(e){
  if (e.target && e.target.id==='buyWithBtn') {
    const buyResult = document.getElementById("buyResult");
    buyResult.textContent = "";
    if (!provider || !signer || !connectedAddress) {
      buyResult.textContent = "Please connect your wallet first."; return; }
    let itcAmount = document.getElementById('itcInput').value;
    try {
      itcAmount = sanitizeAmount(itcAmount);
      if (!itcAmount || isNaN(itcAmount) || +itcAmount <= 0) {
        buyResult.textContent = "Enter a valid ITC amount."; return; }
      const contract = new ethers.Contract(PRESALE_CONTRACT, presaleAbi, signer);
      if (selectedCurrency === "ETH") {
        const ethPricePerToken = PHASE1_PRICE_USDC / currentEthPrice;
        const ethValue = ethers.utils.parseEther((+itcAmount*ethPricePerToken).toString());
        const tx = await contract.buyWithETH(
          ethers.utils.parseUnits(itcAmount, 18),
          { value: ethValue }
        );
        buyResult.textContent = "✅ Transaction sent! Tx Hash: " + tx.hash;
      } else {
        const token = CURRENCIES.find(x=>x.symbol===selectedCurrency);
        const tx = await contract.buyWithToken(
          ethers.utils.parseUnits(itcAmount, 18),
          token.addr
        );
        buyResult.textContent = "✅ Transaction sent! Tx Hash: " + tx.hash;
      }
    } catch (err) {
      buyResult.textContent = "❌ Error: " + (err.message || err);
    }
  }
});
document.getElementById('tab-wallet').onclick = function(){
  document.getElementById('tab-wallet').classList.add('active');
  document.getElementById('tab-card').classList.remove('active');
  showWalletUI();
};
document.getElementById('tab-card').onclick = function(){
  document.getElementById('tab-card').classList.add('active');
  document.getElementById('tab-wallet').classList.remove('active');
  document.getElementById('widget-main-area').innerHTML = `<div style="margin:40px 0 50px 0;font-size:1.15em;color:#aaa;">Pay with Card - Coming Soon!</div>`;
};
showWalletUI();
</script>
</body>
</html>
